!function(t){"use strict";if(t.Pulse)t.console.error("Pulse is already defined");else{var e,n=function(t){var n;e=this,this.audioContext=this._getAudioContext(),this.buffer=null,this.renderedBuffer=null,this.significantPeaks=null,this.beat={ms:null,bpm:null},Object.defineProperty(this,"REQUEST_PROGRESS",{value:101,writable:!1}),Object.defineProperty(this,"REQUEST_LOAD",{value:102,writable:!1}),Object.defineProperty(this,"REQUEST_ERROR",{value:1102,writable:!1}),Object.defineProperty(this,"REQUEST_ABORT",{value:104,writable:!1}),Object.defineProperty(this,"WEB_AUDIO_API_NOT_SUPPORTED",{value:1001,writable:!1}),Object.defineProperty(this,"state",{get:function(){return parseInt(n,10)},set:function(t){t!=n&&(this.notify({type:"update",name:"state",oldValue:t}),n=t)}}),Object.defineProperty(this,"options",{get:function(){return t||this.getDefaultOptions()},set:function(e){var n,r=this.getDefaultOptions();for(n in r)void 0===e[n]&&(e[n]=r[n]);t=e}}),this.options=t};n.prototype.notify=function(t){if("update"===t.type&&"state"===t.name&&t.lastValue!=e.state)switch(e.state){case e.READY:return"READY";case e.WEB_AUDIO_API_NOT_SUPPORTED:return"WEB_AUDIO_API_NOT_SUPPORTED";case e.REQUEST_PROGRESS:return"REQUEST_PROGRESS";case e.REQUEST_LOAD:return"REQUEST_LOAD";case e.REQUEST_ERROR:return"REQUEST_ERROR";case e.REQUEST_ABORT:return"REQUEST_ABORT";default:return"STATE_NOT_IMPLEMENTED_YET"}},n.prototype._getAudioContext=function(){try{return t.AudioContext=t.AudioContext||t.webkitAudioContext,new t.AudioContext}catch(t){return this.state=this.WEB_AUDIO_API_NOT_SUPPORTED,null}},n.prototype.getDefaultOptions=function(){return{onComplete:function(){},onRequestProgress:function(){},onRequestSuccess:function(){},onRequestAbort:function(){},onRequestError:function(){},convertToMilliseconds:!0,removeDuplicates:!0}},n.prototype.loadBufferFromURI=function(n){if(null===this.audioContext)return!1;var r=new t.XMLHttpRequest;return r.open("GET",n,!0),r.responseType="arraybuffer",r.addEventListener("progress",function(t){e._requestProgress(t,this)},!1),r.addEventListener("load",function(t){e._requestLoad(t,this)},!1),r.addEventListener("error",function(){e._requestError(event,this)},!1),r.addEventListener("abort",function(){e._requestAbort(event,this)},!1),r.send(null),!0},n.prototype._requestProgress=function(t,e){this.state=this.REQUEST_PROGRESS,this.options.onRequestProgress(this,e,t)},n.prototype._requestLoad=function(t,e){e.readyState===e.DONE?(this.buffer=e.response,this.state=this.REQUEST_LOAD,this.options.onRequestSuccess(this,e,t),this._process()):this._requestError(t,e,this.options)},n.prototype._requestError=function(t,e){this.state=this.REQUEST_ERROR,this.options.onRequestError(this,e,t)},n.prototype._requestAbort=function(t,e){this.state=this.REQUEST_ABORT,this.options.onRequestAbort(this,e,t)},n.prototype._process=function(){this.audioContext.decodeAudioData(this.buffer,this._processCallback,function(){e.state=e.DECODING_ERROR})},n.prototype._getOfflineContext=function(e){var n=new t.OfflineAudioContext(1,e.length,e.sampleRate),r=n.createBufferSource(),o=n.createBiquadFilter();return r.buffer=e,o.type="lowpass",r.connect(o),o.connect(n.destination),r.start(0),n},n.prototype._processCallback=function(t){var n=e._getOfflineContext(t);n.oncomplete=function(t){e.renderedBuffer=t.renderedBuffer,e.significantPeaks=e.getSignificantPeaks(t),e.beat=e.getBeat(e.significantPeaks),e.options.onComplete(t,e)},n.startRendering()},n.prototype._getChannelDataMinMax=function(t){var e,n=t.length,r=t[0],o=t[0];for(e=1;e<n;e++)r=Math.min(r,t[e]),o=Math.max(o,t[e]);return{min:r,max:o}},n.prototype.getSignificantPeaks=function(){for(var t,n,r=this.renderedBuffer.getChannelData(0),o=this._getChannelDataMinMax(r),s=Math.abs(o.min)+Math.abs(o.max),i=o.min+.9*s,u=o.min+.3*s,a=i,f=.23*this.renderedBuffer.sampleRate,p=[],h=parseInt(this.renderedBuffer.duration,10),c=r.length;a>=u&&p.length<=h;){for(n=0;n<c;n++)r[n]>a&&(p.push(n),n+=f);a-=.05}if(p.sort(function(t,e){return t-e}),e.options.convertToMilliseconds)for(t in p)p[t]=Math.floor(p[t]/this.renderedBuffer.sampleRate*1e3);return e.options.removeDuplicates&&(p=p.filter(function(t,e){return(!e||t>p[e-1])&&t>0})),p},n.prototype.getBeat=function(t){var e,n,r,o,s,i,u,a={},f=0,p=0,h=0,c=[],l=[],d=0;for(n=1;n<t.length;n++)for(r=0;r<n;r++)t[n]-t[r]>=230&&(void 0===a[t[n]-t[r]]&&(a[t[n]-t[r]]=0),a[t[n]-t[r]]++);for(n in a)f+=Math.pow(a[n],2),p++;for(n in o=Math.sqrt(f/p),a)a[n]>o&&(a[n]>h&&(h=a[n],parseInt(n,10)),void 0===c[e=Math.floor(n/500)]&&c.push({max:0,ms:parseInt(n,10)}),void 0!==c[e]&&a[n]>c[e].max&&(c[e]={max:a[n],ms:parseInt(n,10)}));for(s=c.slice(0,3),n=0;n<s.length;n++)for(r in l.push(0),c)l[n]+=c[r].ms%s[n].ms;for(i=l[d=0],n=1;n<l.length;n++)i>l[n]&&(i=l[n],d=n);return u=Math.round(6e4/s[d].ms),{ms:s[d].ms,bpm:u}},n.prototype.getExtrapolatedPeaks=function(t,e,n){var r,o,s,i,u=[],a=[],f=[],p=[];for(r=0;r<e.length;r++)for(o=0;o<r;o++)e[r]-e[o]==n.ms&&(u.push(e[r]),u.push(e[o]));for(u.sort(function(t,e){return t-e}),u=u.filter(function(t,e){return(!e||t>u[e-1]+230)&&t>0}),r=0;r<u.length-1;r++)u[r]+n.ms<=u[r+1]+2&&u[r]+n.ms>=u[r+1]-2?a.push(r):(f.length<a.length&&(f=a),a=[]);if(f.length){for(s=u[f[0]];s>n.ms;)s-=n.ms;for(i=u[f.length-1];i<1e3*t.duration;)i+=n.ms;for(r=s;r<=i;r+=n.ms)p.push(r)}return p},t.Pulse=n}}(window);